 # Oma Moduuli
 
 Aloitin varmistamalla koneeni olevan ajan tasalla, ajoin updatet ja restarttasin.
 
    $ sudo apt-get update
    $ sudo apt-get upgrade
    
Moduulin tarkoituksena on luoda teamspeak käyttäjä johon asennetaan teamspeak3 server ja hyväksytään automaattisesti ehdot ja käynnistetään palvelu yms.

# Käsin

Aloitetaan tekemällä käsin, loin ensin käyttäjän teamspeak, jolta disabloin kirjautumisen.

    $ sudo adduser --disabled-login teamspeak

Sitten selvitin miten teamspeak serverin lataus tapahtuu, ja mitä itse löysin oli että tiedosto täytyy ladata suoraan teamspeakin omilta sivuilta, ettei sitä saa ladattua suoraan paketinhallinnan kautta, joka on minulle saltin kanssa vielä uusi asia.

    $ cd /home/teamspeak/
    $ sudo wget https://files.teamspeak-services.com/releases/server/3.13.2/teamspeak3-server_linux_amd64-3.13.2.tar.bz2
    $ sudo tar xvf teamspeak3-server_linux_amd64-3.13.2.tar.bz2
    $ sudo rm teamspeak3-server_linux_amd64-3.13.2.tar.bz2
    $ cd teamspeak3-server_linux_amd64
    $ sudo mv * /home/teamspeak
    $ sudo rmdir teamspeak3-server_linux_amd64/
    
Tässä vaiheessa teamspeak3-server on ladattu, extractatty, ja siirretty /home/teamspeak/ directoryyn. 

Teamspeak3 serveristä pitää hyväksyä lisenssi, joka tapahtuu luomalla .ts3server_license_accepted tiedosto.
   
    $ sudo touch .ts3server_license_accepted
    
Luodaan teamspeak.service /lib/systemd/system/ directoryyn

    $ sudoedit /lib/systemd/system/teamspeak.service
    
johon lisätään 

    [Unit]
    Description=TeamSpeak 3 Server
    After=network.target
    [Service]
    WorkingDirectory=/home/teamspeak/
    User=teamspeak
    Group=teamspeak
    Type=forking
    ExecStart=/home/teamspeak/ts3server_startscript.sh start inifile=ts3server.ini
    ExecStop=/home/teamspeak/ts3server_startscript.sh stop
    PIDFile=/home/teamspeak/ts3server.pid
    RestartSec=15
    Restart=always
    [Install]
    WantedBy=multi-user.target
    
Sitten palvelun voi käynnistää komennoilla

    $ sudo systemctl enable teamspeak.service
    $ sudo systemctl start teamspeak.service
    
tarkistin toimivuuden 
 
    $ systemctl | grep teamspeak.service
    teamspeak.service                loaded active running   TeamSpeak 3 Server  
    
    $ systemctl status teamspeak.service 
    ● teamspeak.service - TeamSpeak 3 Server
     Loaded: loaded (/lib/systemd/system/teamspeak.service; enabled; vendor prese
     Active: active (running) since Wed 2020-12-16 19:25:25 EET; 2min 20s ago
     Process: 5071 ExecStart=/home/teamspeak/ts3server_startscript.sh start inifil
     Main PID: 5078 (ts3server)
     Tasks: 21 (limit: 4666)
     CGroup: /system.slice/teamspeak.service
           └─5078 ./ts3server inifile=ts3server.ini daemon=1 pid_file=ts3server


Näytti hyvältä. Nyt pitää vielä hakea privilegedkey /teamspeak/logs/ hakemistosta johon ei ole oikeuksia.

    $ sudo cat /home/teamspeak/logs/ts3server_*
    cat: '/home/teamspeak/logs/ts3server_*': No such file or directory
    $ cd /home/teamspeak/logs
    bash: cd: logs: Permission denied
    $ cd /home/teamspeak
    $ ls -la
    drwx------  2 teamspeak teamspeak     4096 joulu 16 19:25 logs
    $ sudo chmod o+rx
    $ cd logs
    $ ls
    ts3server_2020-12-16__17_25_25.551707_0.log  ts3server_2020-12-16__17_25_25.551707_1.log
    $ cat ts3server_2020-12-16__17_25_25.551707_1.log 
    2020-12-16 17:25:26.763688|INFO    |VirtualServerBase|1  |listening on 0.0.0.0:9987, [::]:9987
    2020-12-16 17:25:26.764028|WARNING |VirtualServer |1  |--------------------------------------------------------
    2020-12-16 17:25:26.764042|WARNING |VirtualServer |1  |ServerAdmin privilege key created, please use the line below
    2020-12-16 17:25:26.764051|WARNING |VirtualServer |1  |token=gYor1MTxKwuM1fAS+TDteO9jZIOKxNbKXpS1PNxA
    2020-12-16 17:25:26.764061|WARNING |VirtualServer |1  |--------------------------------------------------------

Sieltä löysimme tarvitsemamme tokenin jota tarvitaan ensimmäisellä yhdistyskerralla.

Sitten vielä latasin clientin ja yritin yhdistää servuun.

    $ sudo wget https://files.teamspeak-services.com/releases/client/3.5.6/TeamSpeak3-Client-linux_amd64-3.5.6.run
    $ sudo ./TeamSpeak3-Client-linux_amd64-3.5.6.run
Poistutaan lisenssin luvusta painamalla q ja hyväksytään lisenssi kirjoittamalla y

    Creating directory TeamSpeak3-Client-linux_amd64
    Verifying archive integrity... All good.
    Uncompressing TeamSpeak 3 Client for Linux on amd64  100%  

Avataan sovellus

    $ cd TeamSpeak3-Client-linux_amd64
    $ ./ts3client_runscript.sh

teamspeak ei tue sudolla avaamista joten saatiin tämmöinen error:
![error](/kuvat/ts3clienterror.PNG)
kun avattiin normaalina käyttäjänä, mutta voidaan painaa ignore ja testata serveriä. Ylemmissä vaiheissa wget ja asennustiedoston ajamisessa ei olisi pitänyt käyttää sudoa, vaan antaa oikeudet chmodilla käyttäjälle ja toimia niin, ettei tulisi erroria. 

Tässä vaiheessa kuitenkin käytän clienttiä vain testatakseni serverin toimivuutta joten ei sillä väliä.

![choosenick](/kuvat/choosenickname.PNG)
![connectlocalhost](/kuvat/connect.PNG)
![connected](/kuvat/firsttimeconnect.PNG)

Ja tässä vaiheessa voidaan antaa token jolla saadaan serverin administrator oikeudet kyseiselle käyttäjälle.

![success](/kuvat/succesfullyused.PNG)

Hyvin toimii ainakin käsin tehtynä, vielä jos tekisin toisin en sorkkisi sudoa kaikkiin kohtiin.
Voin nyt siirtyä saltilla automatisoimaan.
